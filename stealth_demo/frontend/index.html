<!DOCTYPE html>
<html>
<head>
  <meta charset="UTF-8">
  <title>Interactive Stealth Scheme Demo</title>
  <style>
    * {
      margin: 0;
      padding: 0;
      box-sizing: border-box;
    }
    
    body {
      font-family: 'Segoe UI', Tahoma, Geneva, Verdana, sans-serif;
      background: linear-gradient(135deg, #667eea 0%, #764ba2 100%);
      min-height: 100vh;
      padding: 20px;
    }
    
    .container {
      max-width: 1400px;
      margin: 0 auto;
      background: rgba(255, 255, 255, 0.95);
      border-radius: 20px;
      padding: 30px;
      box-shadow: 0 20px 40px rgba(0, 0, 0, 0.1);
    }
    
    h1 {
      text-align: center;
      color: #333;
      margin-bottom: 30px;
      font-size: 2.5em;
      background: linear-gradient(45deg, #667eea, #764ba2);
      -webkit-background-clip: text;
      -webkit-text-fill-color: transparent;
    }
    
    .grid {
      display: grid;
      grid-template-columns: 1fr 1fr;
      gap: 20px;
      margin-bottom: 20px;
      align-items: start; /* è®“æ ¼å­é ‚éƒ¨å°é½Šï¼Œä¸æœƒå› ç‚ºé«˜åº¦ä¸åŒè€Œå±…ä¸­å°é½Š */
    }
    
    .section {
      background: white;
      border-radius: 15px;
      padding: 20px;
      box-shadow: 0 5px 15px rgba(0, 0, 0, 0.1);
      transition: transform 0.3s ease;
      width: 100%; /* å›ºå®šå¯¬åº¦ç‚ºå®¹å™¨çš„100% */
      max-width: 100%; /* é˜²æ­¢è¶…å‡ºå®¹å™¨ */
      box-sizing: border-box; /* ç¢ºä¿paddingä¸æœƒå½±éŸ¿ç¸½å¯¬åº¦ */
    }
    
    .section:hover {
      transform: translateY(-2px);
    }
    
    .section h3 {
      color: #333;
      margin-bottom: 15px;
      font-size: 1.3em;
      border-bottom: 2px solid #667eea;
      padding-bottom: 10px;
    }
    
    button {
      background: linear-gradient(45deg, #667eea, #764ba2);
      color: white;
      border: none;
      padding: 12px 20px;
      border-radius: 8px;
      cursor: pointer;
      margin: 5px;
      font-weight: 600;
      transition: all 0.3s ease;
      min-width: 120px;
    }
    
    button:hover {
      transform: translateY(-2px);
      box-shadow: 0 5px 15px rgba(102, 126, 234, 0.4);
    }
    
    button:disabled {
      background: #ccc;
      cursor: not-allowed;
      transform: none;
      box-shadow: none;
    }
    
    .output {
      margin-top: 10px;
      padding: 15px;
      border: 1px solid #ddd;
      background: #f8f9fa;
      border-radius: 8px;
      white-space: pre-wrap;
      font-family: 'Courier New', monospace;
      font-size: 0.9em;
      max-height: 300px;
      overflow-y: auto;
      word-wrap: break-word; /* å¼·åˆ¶é•·è©æ›è¡Œ */
      word-break: break-all; /* å…è¨±åœ¨ä»»ä½•å­—ç¬¦é–“æ›è¡Œ */
      overflow-wrap: break-word; /* ç¾ä»£ç€è¦½å™¨çš„æ›è¡Œå±¬æ€§ */
      width: 100%; /* ç¢ºä¿è¼¸å‡ºå€åŸŸä¸æœƒè¶…å‡ºå®¹å™¨å¯¬åº¦ */
      box-sizing: border-box;
    }
    
    .output.success {
      border-color: #28a745;
      background: #f8fff9;
    }
    
    .output.error {
      border-color: #dc3545;
      background: #fff8f8;
      color: #dc3545;
    }
    
    select, input[type=text], input[type=number] {
      width: 100%;
      padding: 10px;
      border: 2px solid #ddd;
      border-radius: 8px;
      margin: 5px 0;
      font-size: 1em;
      transition: border-color 0.3s ease;
    }
    
    select:focus, input[type=text]:focus, input[type=number]:focus {
      outline: none;
      border-color: #667eea;
    }
    
    .controls {
      display: flex;
      flex-direction: column;
      gap: 10px;
      margin-bottom: 15px;
    }
    
    .inline-controls {
      display: flex;
      gap: 10px;
      align-items: center;
    }
    
    .status-indicator {
      width: 12px;
      height: 12px;
      border-radius: 50%;
      background: #ccc;
      margin-right: 8px;
      display: inline-block;
    }
    
    .status-indicator.active {
      background: #28a745;
      animation: pulse 2s infinite;
    }
    
    @keyframes pulse {
      0% { opacity: 1; }
      50% { opacity: 0.5; }
      100% { opacity: 1; }
    }
    
    .wide-section {
      grid-column: 1 / -1;
      width: 100%; /* ç¢ºä¿å¯¬åˆ—ä¹Ÿæœ‰å›ºå®šå¯¬åº¦ */
      max-width: 100%;
      box-sizing: border-box;
    }
    
    .data-list {
      max-height: 200px;
      overflow-y: auto;
      border: 1px solid #ddd;
      border-radius: 8px;
      margin: 10px 0;
    }
    
    .data-item {
      padding: 10px;
      border-bottom: 1px solid #eee;
      cursor: pointer;
      transition: background-color 0.3s ease;
    }
    
    .data-item:hover {
      background-color: #f0f0f0;
    }
    
    .data-item:last-child {
      border-bottom: none;
    }
    
    .data-item.selected {
      background-color: #e3f2fd;
      border-left: 4px solid #667eea;
    }
    
    .item-header {
      font-weight: bold;
      color: #333;
      margin-bottom: 5px;
    }
    
    .item-details {
      font-size: 0.9em;
      color: #666;
    }
    
    .loading {
      display: inline-block;
      width: 20px;
      height: 20px;
      border: 3px solid #f3f3f3;
      border-top: 3px solid #667eea;
      border-radius: 50%;
      animation: spin 1s linear infinite;
      margin-right: 10px;
    }
    
    @keyframes spin {
      0% { transform: rotate(0deg); }
      100% { transform: rotate(360deg); }
    }
    
    .hex-display {
      font-family: 'Courier New', monospace;
      font-size: 0.8em;
      color: #666;
      word-break: break-all; /* è®“é•·hexå­—ä¸²è‡ªå‹•æ›è¡Œ */
      overflow-wrap: break-word;
      line-height: 1.4; /* å¢åŠ è¡Œé«˜è®“å¤šè¡Œé¡¯ç¤ºæ›´æ¸…æ¥š */
    }
    
    .tabs {
      display: flex;
      border-bottom: 2px solid #ddd;
      margin-bottom: 20px;
    }
    
    .tab {
      padding: 10px 20px;
      cursor: pointer;
      border-bottom: 2px solid transparent;
      transition: all 0.3s ease;
    }
    
    .tab.active {
      border-bottom-color: #667eea;
      color: #667eea;
      font-weight: bold;
    }
    
    .tab-content {
      display: none;
    }
    
    .tab-content.active {
      display: block;
    }

    /* éŸ¿æ‡‰å¼è¨­è¨ˆï¼šåœ¨ä¸åŒè¢å¹•å¯¬åº¦ä¸‹èª¿æ•´åˆ—æ•¸ */
    @media (max-width: 1200px) {
      .grid {
        grid-template-columns: 1fr; /* å°è¢å¹•æ”¹ç‚ºå–®åˆ— */
      }
      
      .wide-section {
        grid-column: 1; /* å–®åˆ—æ™‚ä¸éœ€è¦è·¨åˆ— */
      }
    }
    
    @media (min-width: 1600px) {
      .container {
        max-width: 1600px; /* å¤§è¢å¹•å¯ä»¥æ›´å¯¬ */
      }
    }
    
    .tab {
      padding: 10px 20px;
      cursor: pointer;
      border-bottom: 2px solid transparent;
      transition: all 0.3s ease;
    }
    
    .tab.active {
      border-bottom-color: #667eea;
      color: #667eea;
      font-weight: bold;
    }
    
    .tab-content {
      display: none;
    }
    
    .tab-content.active {
      display: block;
    }

    /* Performance test styles */
    .performance-section {
      background: linear-gradient(135deg, #f8f9fa 0%, #e9ecef 100%);
      border: 2px solid #667eea;
    }

    .performance-grid {
      display: grid;
      grid-template-columns: repeat(auto-fit, minmax(150px, 1fr));
      gap: 10px;
      margin: 15px 0;
    }

    .perf-metric {
      background: white;
      padding: 10px;
      border-radius: 8px;
      text-align: center;
      box-shadow: 0 2px 8px rgba(0,0,0,0.1);
    }

    .perf-value {
      font-size: 1.2em;
      font-weight: bold;
      color: #667eea;
    }

    .perf-label {
      font-size: 0.9em;
      color: #666;
      margin-top: 5px;
    }

    /* Transaction message styles */
    .tx-message {
      background: #fff3cd;
      border: 1px solid #ffeaa7;
      border-radius: 8px;
      padding: 15px;
      margin: 10px 0;
      border-left: 4px solid #fdcb6e;
    }

    .tx-header {
      font-weight: bold;
      color: #856404;
      margin-bottom: 10px;
    }

    .tx-field {
      margin: 5px 0;
      font-family: 'Courier New', monospace;
      font-size: 0.85em;
    }

    .tx-field-label {
      font-weight: bold;
      color: #495057;
    }
  </style>
</head>
<body>
  <div class="container">
    <h1>ğŸ” Interactive Stealth Scheme Demo</h1>
    
    <div class="grid">
      <!-- Setup Section with Parameter Selection -->
      <div class="section">
        <h3>ğŸ”§ System Setup</h3>
        <div class="controls">
          <span class="status-indicator" id="setup-status"></span>
          <label>Select Parameter File:</label>
          <select id="param-select">
            <option value="">Loading parameter files...</option>
          </select>
          <button onclick="callSetup()" id="setup-btn">Initialize with Selected Param</button>
        </div>
        <div class="output" id="output-setup"></div>
      </div>

      <!-- Key Management Section -->
      <div class="section">
        <h3>ğŸ”‘ Key Management</h3>
        <div class="controls">
          <button onclick="callKeyGen()" id="keygen-btn">Generate New Key</button>
          <button onclick="loadKeyList()">Refresh Key List</button>
        </div>
        <div class="data-list" id="key-list"></div>
        <div class="output" id="output-keygen"></div>
      </div>

      <!-- Address Generation Section -->
      <div class="section">
        <h3>ğŸ“§ Address Generation</h3>
        <div class="controls">
          <label>Select Key for Address Generation:</label>
          <select id="addr-key-select">
            <option value="">Select a key...</option>
          </select>
          <button onclick="callAddrGen()" id="addr-btn">Generate Address</button>
        </div>
        <div class="data-list" id="address-list"></div>
        <div class="output" id="output-addr"></div>
      </div>

      <!-- Address Verification Section -->
      <div class="section">
        <h3>ğŸ” Address Verification</h3>
        <div class="controls">
          <label>Select Address to Verify:</label>
          <select id="verify-addr-select">
            <option value="">Select an address...</option>
          </select>
          <label>Select Key for Verification:</label>
          <select id="verify-key-select">
            <option value="">Select a key...</option>
          </select>
          <button onclick="callAddrVerify()" id="verify-btn">Verify Address</button>
        </div>
        <div class="output" id="output-verify"></div>
      </div>

      <!-- DSK Generation Section -->
      <div class="section">
        <h3>ğŸ” DSK Generation</h3>
        <div class="controls">
          <label>Select Address:</label>
          <select id="dsk-addr-select">
            <option value="">Select an address...</option>
          </select>
          <label>Select Owner Key:</label>
          <select id="dsk-key-select">
            <option value="">Select a key...</option>
          </select>
          <button onclick="callDSKGen()" id="dsk-btn">Generate DSK</button>
        </div>
        <div class="data-list" id="dsk-list"></div>
        <div class="output" id="output-dsk"></div>
      </div>

      <!-- Signing Section -->
      <div class="section">
        <h3>âœï¸ Message Signing</h3>
        <div class="controls">
          <input type="text" id="message-input" placeholder="Enter message to sign..." value="Test transaction message">
          <label>Select DSK for Signing:</label>
          <select id="sign-dsk-select">
            <option value="">Select a DSK...</option>
          </select>
          <button onclick="callSign()" id="sign-btn">Sign Message</button>
        </div>
        <div id="tx-messages-list"></div>
        <div class="output" id="output-sign"></div>
      </div>

      <!-- Signature Verification Section -->
      <div class="section wide-section">
        <h3>âœ… Signature Verification</h3>
        <div class="controls">
          <div class="inline-controls">
            <label>Select Transaction Message to Verify:</label>
            <select id="tx-message-select">
              <option value="">Select a transaction message...</option>
            </select>
            <button onclick="callVerifySignature()" id="verify-sig-btn">Verify Signature</button>
          </div>
        </div>
        <div class="output" id="output-verify-sig"></div>
      </div>

      <!-- Identity Tracing Section -->
      <div class="section wide-section">
        <h3>ğŸ” Identity Tracing</h3>
        <div class="controls">
          <div class="inline-controls">
            <label>Select Address to Trace:</label>
            <select id="trace-addr-select">
              <option value="">Select an address...</option>
            </select>
            <button onclick="callTrace()" id="trace-btn">Trace Identity</button>
          </div>
        </div>
        <div class="output" id="output-trace"></div>
      </div>

      <!-- Performance Test Section -->
      <div class="section wide-section performance-section">
        <h3>ğŸ“Š Performance Test</h3>
        <div class="controls">
          <div class="inline-controls">
            <label>Number of iterations:</label>
            <input type="number" id="perf-iterations" value="100" min="1" max="1000" style="width: 100px;">
            <button onclick="callPerformanceTest()" id="perf-btn">Run Performance Test</button>
          </div>
        </div>
        <div class="performance-grid" id="performance-results"></div>
        <div class="output" id="output-performance"></div>
      </div>
    </div>
  </div>

  <script>
    let state = {
      keys: [],
      addresses: [],
      dsks: [],
      txMessages: [],
      traceKey: null,
      selectedKeyIndex: -1,
      selectedAddrIndex: -1,
      selectedDSKIndex: -1,
      setupComplete: false,
      currentParamFile: null
    };

    // Utility functions
    function showLoading(buttonId) {
      const btn = document.getElementById(buttonId);
      btn.disabled = true;
      const originalText = btn.textContent;
      btn.innerHTML = '<span class="loading"></span>' + originalText;
      return originalText;
    }

    function hideLoading(buttonId, originalText) {
      const btn = document.getElementById(buttonId);
      btn.disabled = false;
      btn.innerHTML = originalText;
    }

    function updateStatusIndicator(indicatorId, active = false) {
      const indicator = document.getElementById(indicatorId);
      if (active) {
        indicator.classList.add('active');
      } else {
        indicator.classList.remove('active');
      }
    }

    function displayOutput(outputId, content, isError = false) {
      const output = document.getElementById(outputId);
      output.innerHTML = content;
      output.className = 'output ' + (isError ? 'error' : 'success');
    }

    function truncateHex(hex, length = 16) {
      if (!hex) return '';
      if (hex.length <= length * 2) return hex;
      return hex.substring(0, length) + '...' + hex.substring(hex.length - 8);
    }

    // Load parameter files on startup
    async function loadParamFiles() {
      try {
        const res = await fetch('/param_files');
        if (!res.ok) throw new Error('Failed to load parameter files');
        
        const data = await res.json();
        const select = document.getElementById('param-select');
        
        select.innerHTML = '<option value="">Select a parameter file...</option>';
        
        data.param_files.forEach(file => {
          const option = document.createElement('option');
          option.value = file.name;
          option.textContent = `${file.name} (${file.size} bytes)`;
          select.appendChild(option);
        });
        
        if (data.current) {
          select.value = data.current;
          state.currentParamFile = data.current;
        }
        
      } catch (error) {
        displayOutput('output-setup', 'Error loading parameter files: ' + error.message, true);
      }
    }

    // API calls
    async function callSetup() {
      const originalText = showLoading('setup-btn');
      try {
        const paramFile = document.getElementById('param-select').value;
        if (!paramFile) {
          throw new Error('Please select a parameter file');
        }
        
        const res = await fetch('/setup', {
          method: 'POST',
          headers: { 'Content-Type': 'application/json' },
          body: JSON.stringify({ param_file: paramFile })
        });
        
        if (!res.ok) throw new Error('Setup failed');
        
        const data = await res.json();
        state.traceKey = data;
        state.setupComplete = true;
        state.currentParamFile = paramFile;
        
        updateStatusIndicator('setup-status', true);
        displayOutput('output-setup', `âœ… System Initialized Successfully!
ğŸ“„ Parameter File: ${paramFile}
ğŸ”‘ Trace Key: ${truncateHex(data.TK_hex)}
ğŸ” K Value: ${truncateHex(data.k_hex)}
ğŸ“Š G1 Size: ${data.g1_size} bytes
ğŸ“Š Zr Size: ${data.zr_size} bytes
âœ… Status: ${data.status}`);
        
        // Reset all lists
        state.keys = [];
        state.addresses = [];
        state.dsks = [];
        state.txMessages = [];
        updateAllLists();
        
      } catch (error) {
        displayOutput('output-setup', 'Error: ' + error.message, true);
      }
      hideLoading('setup-btn', originalText);
    }

    async function callKeyGen() {
      if (!state.setupComplete) {
        alert("Please run Setup first!");
        return;
      }
      
      const originalText = showLoading('keygen-btn');
      try {
        const res = await fetch('/keygen');
        if (!res.ok) throw new Error('KeyGen failed');
        
        const data = await res.json();
        state.keys.push(data);
        
        updateAllLists();
        displayOutput('output-keygen', `âœ… Key Generated Successfully!
ğŸ†” Key ID: ${data.id}
ğŸ”“ Public Key A: ${truncateHex(data.A_hex)}
ğŸ”“ Public Key B: ${truncateHex(data.B_hex)}
ğŸ” Private Key a: ${truncateHex(data.a_hex)}
ğŸ” Private Key b: ${truncateHex(data.b_hex)}`);
        
      } catch (error) {
        displayOutput('output-keygen', 'Error: ' + error.message, true);
      }
      hideLoading('keygen-btn', originalText);
    }

    async function loadKeyList() {
      try {
        const res = await fetch('/keylist');
        if (!res.ok) throw new Error('Failed to load keys');
        
        state.keys = await res.json();
        updateAllLists();
        
      } catch (error) {
        displayOutput('output-keygen', 'Error loading keys: ' + error.message, true);
      }
    }

    async function callAddrGen() {
      if (!state.setupComplete) {
        alert("Please run Setup first!");
        return;
      }
      
      const keyIndex = parseInt(document.getElementById('addr-key-select').value);
      if (isNaN(keyIndex)) {
        alert("Please select a key!");
        return;
      }
      
      const originalText = showLoading('addr-btn');
      try {
        const res = await fetch('/addrgen', {
          method: 'POST',
          headers: { 'Content-Type': 'application/json' },
          body: JSON.stringify({ key_index: keyIndex })
        });
        
        if (!res.ok) throw new Error('Address generation failed');
        
        const data = await res.json();
        state.addresses.push(data);
        
        updateAllLists();
        displayOutput('output-addr', `âœ… Address Generated Successfully!
ğŸ†” Address ID: ${data.id}
ğŸ‘¤ Owner Key: ${data.key_id}
ğŸ  Address: ${truncateHex(data.addr_hex)}
ğŸ² R1: ${truncateHex(data.r1_hex)}
ğŸ² R2: ${truncateHex(data.r2_hex)}
ğŸ”’ C: ${truncateHex(data.c_hex)}`);
        
      } catch (error) {
        displayOutput('output-addr', 'Error: ' + error.message, true);
      }
      hideLoading('addr-btn', originalText);
    }

    async function callAddrVerify() {
      const addrIndex = parseInt(document.getElementById('verify-addr-select').value);
      const keyIndex = parseInt(document.getElementById('verify-key-select').value);
      
      if (isNaN(addrIndex) || isNaN(keyIndex)) {
        alert("Please select both an address and a key!");
        return;
      }
      
      const originalText = showLoading('verify-btn');
      try {
        const res = await fetch('/verify_addr', {
          method: 'POST',
          headers: { 'Content-Type': 'application/json' },
          body: JSON.stringify({ 
            address_index: addrIndex,
            key_index: keyIndex
          })
        });
        
        if (!res.ok) throw new Error('Address verification failed');
        
        const data = await res.json();
        displayOutput('output-verify', `ğŸ” Address Verification Results:
ğŸ“§ Address: ${data.address_id}
ğŸ”‘ Key Used: ${data.key_id}
ğŸ‘¤ Is Owner: ${data.is_owner ? 'âœ… Yes' : 'âŒ No'}
âœ… Verification Result: ${data.valid ? 'âœ… Valid' : 'âŒ Invalid'}
ğŸ“Š Status: ${data.status}`);
        
      } catch (error) {
        displayOutput('output-verify', 'Error: ' + error.message, true);
      }
      hideLoading('verify-btn', originalText);
    }

    async function callDSKGen() {
      const addrIndex = parseInt(document.getElementById('dsk-addr-select').value);
      const keyIndex = parseInt(document.getElementById('dsk-key-select').value);
      
      if (isNaN(addrIndex) || isNaN(keyIndex)) {
        alert("Please select both an address and a key!");
        return;
      }
      
      const originalText = showLoading('dsk-btn');
      try {
        const res = await fetch('/dskgen', {
          method: 'POST',
          headers: { 'Content-Type': 'application/json' },
          body: JSON.stringify({ 
            address_index: addrIndex,
            key_index: keyIndex
          })
        });
        
        if (!res.ok) throw new Error('DSK generation failed');
        
        const data = await res.json();
        state.dsks.push(data);
        
        updateAllLists();
        displayOutput('output-dsk', `âœ… DSK Generated Successfully!
ğŸ†” DSK ID: ${data.id}
ğŸ” DSK: ${truncateHex(data.dsk_hex)}
ğŸ“§ For Address: ${data.address_id}
ğŸ‘¤ Owner Key: ${data.key_id}
ğŸ  Address: ${truncateHex(data.for_address)}`);
        
      } catch (error) {
        displayOutput('output-dsk', 'Error: ' + error.message, true);
      }
      hideLoading('dsk-btn', originalText);
    }

    async function callSign() {
      const message = document.getElementById('message-input').value;
      const dskIndex = parseInt(document.getElementById('sign-dsk-select').value);
      
      if (!message.trim()) {
        alert("Please enter a message to sign!");
        return;
      }
      
      if (isNaN(dskIndex)) {
        alert("Please select a DSK!");
        return;
      }
      
      const originalText = showLoading('sign-btn');
      try {
        const res = await fetch('/sign', {
          method: 'POST',
          headers: { 'Content-Type': 'application/json' },
          body: JSON.stringify({
            message: message,
            dsk_index: dskIndex
          })
        });
        
        if (!res.ok) throw new Error('Signing failed');
        
        const data = await res.json();
        
        // Create transaction message
        const txMessage = {
          id: `tx_${state.txMessages.length}`,
          message: message,
          address_index: data.address_index,
          address_id: data.address_id,
          dsk_id: data.dsk_id,
          q_sigma_hex: data.q_sigma_hex,
          h_hex: data.h_hex,
          r2_hex: state.addresses[data.address_index].r2_hex,
          c_hex: state.addresses[data.address_index].c_hex,
          addr_hex: state.addresses[data.address_index].addr_hex,
          timestamp: new Date().toISOString()
        };
        
        state.txMessages.push(txMessage);
        updateTxMessagesList();
        updateTxMessageSelect();
        
        displayOutput('output-sign', `âœ… Message Signed Successfully!
ğŸ“ Message: "${message}"
ğŸ” DSK Used: ${data.dsk_id}
ğŸ“§ Address: ${data.address_id}
ğŸ” Q_sigma: ${truncateHex(data.q_sigma_hex)}
ğŸ”‘ H: ${truncateHex(data.h_hex)}
ğŸ“¦ Transaction Message Created: ${txMessage.id}`);
        
      } catch (error) {
        displayOutput('output-sign', 'Error: ' + error.message, true);
      }
      hideLoading('sign-btn', originalText);
    }

    async function callVerifySignature() {
      const txIndex = parseInt(document.getElementById('tx-message-select').value);
      
      if (isNaN(txIndex)) {
        alert("Please select a transaction message!");
        return;
      }
      
      const originalText = showLoading('verify-sig-btn');
      try {
        const txMessage = state.txMessages[txIndex];
        
        const res = await fetch('/verify_signature', {
          method: 'POST',
          headers: { 'Content-Type': 'application/json' },
          body: JSON.stringify({
            message: txMessage.message,
            q_sigma_hex: txMessage.q_sigma_hex,
            h_hex: txMessage.h_hex,
            address_index: txMessage.address_index
          })
        });
        
        if (!res.ok) throw new Error('Signature verification failed');
        
        const data = await res.json();
        displayOutput('output-verify-sig', `ğŸ” Signature Verification Results:
ğŸ“¦ Transaction: ${txMessage.id}
ğŸ“ Message: "${txMessage.message}"
ğŸ“§ Address: ${data.address_id}
âœ… Verification Result: ${data.valid ? 'âœ… Valid Signature' : 'âŒ Invalid Signature'}
ğŸ“Š Status: ${data.status}`);
        
      } catch (error) {
        displayOutput('output-verify-sig', 'Error: ' + error.message, true);
      }
      hideLoading('verify-sig-btn', originalText);
    }

    async function callTrace() {
      const addrIndex = parseInt(document.getElementById('trace-addr-select').value);
      
      if (isNaN(addrIndex)) {
        alert("Please select an address to trace!");
        return;
      }
      
      const originalText = showLoading('trace-btn');
      try {
        const res = await fetch('/trace', {
          method: 'POST',
          headers: { 'Content-Type': 'application/json' },
          body: JSON.stringify({ address_index: addrIndex })
        });
        
        if (!res.ok) throw new Error('Identity tracing failed');
        
        const data = await res.json();
        displayOutput('output-trace', `ğŸ” Identity Tracing Results:
ğŸ“§ Traced Address: ${data.address_id}
ğŸ” Recovered B: ${truncateHex(data.recovered_b_hex)}
ğŸ‘¤ Original Owner: ${data.original_owner.key_id}
ğŸ”‘ Original B: ${truncateHex(data.original_owner.B_hex)}
ğŸ¯ Perfect Match: ${data.perfect_match ? 'âœ… Yes' : 'âŒ No'}
${data.matched_key ? `âœ… Matched Key: ${data.matched_key.id}` : 'âš ï¸ No exact match found'}
ğŸ“Š Status: ${data.status}`);
        
      } catch (error) {
        displayOutput('output-trace', 'Error: ' + error.message, true);
      }
      hideLoading('trace-btn', originalText);
    }

    async function callPerformanceTest() {
      if (!state.setupComplete) {
        alert("Please run Setup first!");
        return;
      }
      
      const iterations = parseInt(document.getElementById('perf-iterations').value) || 100;
      const originalText = showLoading('perf-btn');
      
      try {
        const res = await fetch('/performance_test', {
          method: 'POST',
          headers: { 'Content-Type': 'application/json' },
          body: JSON.stringify({ iterations: iterations })
        });
        
        if (!res.ok) throw new Error('Performance test failed');
        
        const data = await res.json();
        
        // Update performance results display
        const resultsGrid = document.getElementById('performance-results');
        resultsGrid.innerHTML = `
          <div class="perf-metric">
            <div class="perf-value">${data.addr_gen_ms}</div>
            <div class="perf-label">Address Gen (ms)</div>
          </div>
          <div class="perf-metric">
            <div class="perf-value">${data.addr_verify_ms}</div>
            <div class="perf-label">Addr Verify (ms)</div>
          </div>
          <div class="perf-metric">
            <div class="perf-value">${data.fast_verify_ms}</div>
            <div class="perf-label">Fast Verify (ms)</div>
          </div>
          <div class="perf-metric">
            <div class="perf-value">${data.sign_ms}</div>
            <div class="perf-label">Signing (ms)</div>
          </div>
          <div class="perf-metric">
            <div class="perf-value">${data.sig_verify_ms}</div>
            <div class="perf-label">Sig Verify (ms)</div>
          </div>
          <div class="perf-metric">
            <div class="perf-value">${data.trace_ms}</div>
            <div class="perf-label">Tracing (ms)</div>
          </div>
          <div class="perf-metric">
            <div class="perf-value">${data.onetime_sk_ms}</div>
            <div class="perf-label">DSK Gen (ms)</div>
          </div>
        `;
        
        displayOutput('output-performance', `âœ… Performance Test Completed!
ğŸ”„ Iterations: ${data.iterations}
ğŸ“Š All metrics displayed above
âš¡ Total operations: ${data.iterations * 7}`);
        
      } catch (error) {
        displayOutput('output-performance', 'Error: ' + error.message, true);
      }
      hideLoading('perf-btn', originalText);
    }

    // Update all dropdown lists and data displays
    function updateAllLists() {
      updateKeySelects();
      updateAddressSelects();
      updateDSKSelects();
      updateDataLists();
      updateTxMessageSelect();
    }

    function updateKeySelects() {
      const selects = ['addr-key-select', 'verify-key-select', 'dsk-key-select'];
      
      selects.forEach(selectId => {
        const select = document.getElementById(selectId);
        select.innerHTML = '<option value="">Select a key...</option>';
        
        state.keys.forEach((key, index) => {
          const option = document.createElement('option');
          option.value = index;
          option.textContent = `${key.id} - A: ${truncateHex(key.A_hex, 8)}`;
          select.appendChild(option);
        });
      });
    }

    function updateAddressSelects() {
      const selects = ['verify-addr-select', 'dsk-addr-select', 'trace-addr-select'];
      
      selects.forEach(selectId => {
        const select = document.getElementById(selectId);
        select.innerHTML = '<option value="">Select an address...</option>';
        
        state.addresses.forEach((addr, index) => {
          const option = document.createElement('option');
          option.value = index;
          option.textContent = `${addr.id} - Owner: ${addr.key_id}`;
          select.appendChild(option);
        });
      });
    }

    function updateDSKSelects() {
      const select = document.getElementById('sign-dsk-select');
      select.innerHTML = '<option value="">Select a DSK...</option>';
      
      state.dsks.forEach((dsk, index) => {
        const option = document.createElement('option');
        option.value = index;
        option.textContent = `${dsk.id} - For: ${dsk.address_id}`;
        select.appendChild(option);
      });
    }

    function updateTxMessageSelect() {
      const select = document.getElementById('tx-message-select');
      select.innerHTML = '<option value="">Select a transaction message...</option>';
      
      state.txMessages.forEach((tx, index) => {
        const option = document.createElement('option');
        option.value = index;
        option.textContent = `${tx.id} - "${tx.message.substring(0, 30)}${tx.message.length > 30 ? '...' : ''}"`;
        select.appendChild(option);
      });
    }

    function updateTxMessagesList() {
      const container = document.getElementById('tx-messages-list');
      container.innerHTML = '';
      
      state.txMessages.forEach((tx, index) => {
        const txDiv = document.createElement('div');
        txDiv.className = 'tx-message';
        txDiv.innerHTML = `
          <div class="tx-header">ğŸ“¦ ${tx.id} - ${new Date(tx.timestamp).toLocaleString()}</div>
          <div class="tx-field"><span class="tx-field-label">Message:</span> "${tx.message}"</div>
          <div class="tx-field"><span class="tx-field-label">Address:</span> ${truncateHex(tx.addr_hex, 12)}</div>
          <div class="tx-field"><span class="tx-field-label">Signature:</span> ${truncateHex(tx.q_sigma_hex, 12)}</div>
        `;
        container.appendChild(txDiv);
      });
    }

    function updateDataLists() {
      // Update key list with click handlers
      const keyList = document.getElementById('key-list');
      keyList.innerHTML = '';
      state.keys.forEach((key, index) => {
        const item = document.createElement('div');
        item.className = 'data-item';
        item.onclick = () => showKeyDetails(index);
        item.innerHTML = `
          <div class="item-header">${key.id}</div>
          <div class="item-details">A: ${truncateHex(key.A_hex, 12)}</div>
          <div class="item-details">B: ${truncateHex(key.B_hex, 12)}</div>
        `;
        keyList.appendChild(item);
      });
      
      // Update address list with click handlers
      const addrList = document.getElementById('address-list');
      addrList.innerHTML = '';
      state.addresses.forEach((addr, index) => {
        const item = document.createElement('div');
        item.className = 'data-item';
        item.onclick = () => showAddressDetails(index);
        item.innerHTML = `
          <div class="item-header">${addr.id} (Owner: ${addr.key_id})</div>
          <div class="item-details hex-display">${truncateHex(addr.addr_hex, 20)}</div>
        `;
        addrList.appendChild(item);
      });
      
      // Update DSK list with click handlers
      const dskList = document.getElementById('dsk-list');
      dskList.innerHTML = '';
      state.dsks.forEach((dsk, index) => {
        const item = document.createElement('div');
        item.className = 'data-item';
        item.onclick = () => showDSKDetails(index);
        item.innerHTML = `
          <div class="item-header">${dsk.id}</div>
          <div class="item-details">For: ${dsk.address_id} (Owner: ${dsk.key_id})</div>
          <div class="item-details hex-display">${truncateHex(dsk.dsk_hex, 16)}</div>
        `;
        dskList.appendChild(item);
      });
    }

    // Detail display functions for clickable items
    function showKeyDetails(index) {
      const key = state.keys[index];
      state.selectedKeyIndex = index;
      
      // Update selection visually
      document.querySelectorAll('#key-list .data-item').forEach((item, i) => {
        item.classList.toggle('selected', i === index);
      });
      
      displayOutput('output-keygen', `ğŸ” Key Details - ${key.id}
ğŸ†” Index: ${index}
ğŸ“„ Parameter File: ${key.param_file}
ğŸ“Š Status: ${key.status}

ğŸ”“ Public Key A:
${key.A_hex}

ğŸ”“ Public Key B:
${key.B_hex}

ğŸ” Private Key a:
${key.a_hex}

ğŸ” Private Key b:
${key.b_hex}`);
    }

    function showAddressDetails(index) {
      const addr = state.addresses[index];
      state.selectedAddrIndex = index;
      
      // Update selection visually
      document.querySelectorAll('#address-list .data-item').forEach((item, i) => {
        item.classList.toggle('selected', i === index);
      });
      
      displayOutput('output-addr', `ğŸ” Address Details - ${addr.id}
ğŸ†” Index: ${index}
ğŸ‘¤ Owner Key: ${addr.key_id} (Index: ${addr.key_index})
ğŸ“Š Status: ${addr.status}

ğŸ  Address:
${addr.addr_hex}

ğŸ² R1:
${addr.r1_hex}

ğŸ² R2:
${addr.r2_hex}

ğŸ”’ C:
${addr.c_hex}`);
    }

    function showDSKDetails(index) {
      const dsk = state.dsks[index];
      state.selectedDSKIndex = index;
      
      // Update selection visually
      document.querySelectorAll('#dsk-list .data-item').forEach((item, i) => {
        item.classList.toggle('selected', i === index);
      });
      
      displayOutput('output-dsk', `ğŸ” DSK Details - ${dsk.id}
ğŸ†” Index: ${index}
ğŸ“§ For Address: ${dsk.address_id} (Index: ${dsk.address_index})
ğŸ‘¤ Owner Key: ${dsk.key_id} (Index: ${dsk.key_index})
ğŸ”§ Generation Method: ${dsk.method}
ğŸ“Š Status: ${dsk.status}

ğŸ” DSK:
${dsk.dsk_hex}

ğŸ  Address Hex:
${dsk.for_address}`);
    }

    // Initialize page
    window.onload = function () {
      loadParamFiles();
      loadKeyList();
    };
  </script>
</body>
</html>