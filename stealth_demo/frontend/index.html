<!DOCTYPE html>
<html>
<head>
  <meta charset="UTF-8">
  <title>Stealth Scheme Demo</title>
  <style>
    body { font-family: Arial, sans-serif; margin: 20px; }
    button { margin: 5px; padding: 8px 12px; }
    .section { margin-top: 15px; }
    .output { margin-top: 5px; padding: 8px; border: 1px solid #ccc; background: #f9f9f9; white-space: pre-wrap; }
    input[type=text] { width: 300px; padding: 6px; }
    select { padding: 5px; }
  </style>
</head>
<body>
  <h1>Stealth Scheme Demo</h1>

  <div class="section">
    <button onclick="callSetup()">0. Setup (Trace Key)</button>
    <div class="output" id="output-setup"></div>
  </div>

  <div class="section">
    <button onclick="callKeyGen()">1. KeyGen</button>
    <button onclick="loadKeyList()">Load Key List</button>
    <select id="key-select"></select>
    <div class="output" id="output-keygen"></div>
  </div>

  <div class="section">
    <button onclick="callAddrGen()">2. Generate Address (by selected key)</button>
    <div class="output" id="output-addr"></div>
  </div>

  <script>
    let state = {
      keys: [],
      traceKey: null,
      selectedKeyIndex: 0
    };

    async function callSetup() {
      const res = await fetch('/setup');
      const data = await res.json();
      state.traceKey = data;
      document.getElementById('output-setup').innerText = '[Trace Key]\n' + JSON.stringify(data, null, 2);
    }

    async function callKeyGen() {
      const res = await fetch('/keygen');
      const data = await res.json();
      state.keys.push(data);
      updateKeyDropdown();
      document.getElementById('output-keygen').innerText = '[KeyGen]\n' + JSON.stringify(data, null, 2);
    }

    async function loadKeyList() {
      const res = await fetch('/keylist');
      const list = await res.json();
      state.keys = list;
      updateKeyDropdown();
    }

    function updateKeyDropdown() {
      const sel = document.getElementById('key-select');
      sel.innerHTML = '';
      state.keys.forEach((k, i) => {
        const opt = document.createElement('option');
        opt.value = i;
        opt.text = `Key ${i}`;
        sel.appendChild(opt);
      });
      state.selectedKeyIndex = 0;
    }

    async function callAddrGen() {
      if (state.keys.length === 0) {
        alert("No keys available. Please generate or load keys first.");
        return;
      }
      if (!state.traceKey) {
        alert("Trace key not set. Please run Setup first.");
        return;
      }
      const key = state.keys[state.selectedKeyIndex];
      const res = await fetch('/addrgen', {
        method: 'POST',
        headers: { 'Content-Type': 'application/json' },
        body: JSON.stringify({ A_hex: key.A_hex, B_hex: key.B_hex })
      });
      const data = await res.json();
      if (!res.ok) {
        alert("Error: " + (data.error || "Unknown"));
        return;
      }
      document.getElementById('output-addr').innerText = '[AddrGen]\n' + JSON.stringify(data, null, 2);
    }

    window.onload = function () {
      const sel = document.getElementById('key-select');
      sel.addEventListener('change', function () {
        state.selectedKeyIndex = parseInt(this.value);
      });
    };
  </script>
</body>
</html>
